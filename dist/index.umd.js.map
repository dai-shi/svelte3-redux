{"version":3,"file":"index.umd.js","sources":["../src/deepProxy.js","../src/bind.ts","../src/bindTracked.ts"],"sourcesContent":["// -------------------------------------------------------\n// deep proxy\n// -------------------------------------------------------\n\nconst OWN_KEYS_SYMBOL = Symbol('OWN_KEYS');\n\n// check if obj is a plain object or an array\nconst isPlainObject = (obj) => {\n  try {\n    const proto = Object.getPrototypeOf(obj);\n    return proto === Object.prototype || proto === Array.prototype;\n  } catch (e) {\n    return false;\n  }\n};\n\n// copy obj if frozen\nconst unfreeze = (obj) => {\n  if (!Object.isFrozen(obj)) return obj;\n  if (Array.isArray(obj)) {\n    return Array.from(obj);\n  }\n  return Object.assign({}, obj);\n};\n\nconst createProxyHandler = () => ({\n  recordUsage(key) {\n    let used = this.affected.get(this.originalObj);\n    if (!used) {\n      used = new Set();\n      this.affected.set(this.originalObj, used);\n    }\n    used.add(key);\n  },\n  get(target, key) {\n    this.recordUsage(key);\n    // eslint-disable-next-line no-use-before-define, @typescript-eslint/no-use-before-define\n    return createDeepProxy(target[key], this.affected, this.proxyCache);\n  },\n  has(target, key) {\n    // LIMITATION:\n    // We simply record the same as get.\n    // This means { a: {} } and { a: {} } is detected as changed,\n    // if 'a' in obj is handled.\n    this.recordUsage(key);\n    return key in target;\n  },\n  ownKeys(target) {\n    this.recordUsage(OWN_KEYS_SYMBOL);\n    return Reflect.ownKeys(target);\n  },\n});\n\nexport const createDeepProxy = (obj, affected, proxyCache) => {\n  if (!isPlainObject(obj)) return obj;\n  let proxyHandler = proxyCache && proxyCache.get(obj);\n  if (!proxyHandler) {\n    proxyHandler = createProxyHandler();\n    proxyHandler.proxy = new Proxy(unfreeze(obj), proxyHandler);\n    proxyHandler.originalObj = obj;\n    if (proxyCache) {\n      proxyCache.set(obj, proxyHandler);\n    }\n  }\n  proxyHandler.affected = affected;\n  proxyHandler.proxyCache = proxyCache;\n  return proxyHandler.proxy;\n};\n\nconst isOwnKeysChanged = (origObj, nextObj) => {\n  const origKeys = Reflect.ownKeys(origObj);\n  const nextKeys = Reflect.ownKeys(nextObj);\n  return origKeys.length !== nextKeys.length\n    || origKeys.some((k, i) => k !== nextKeys[i]);\n};\n\nexport const isDeepChanged = (\n  origObj,\n  nextObj,\n  affected,\n  cache,\n  assumeChangedIfNotAffected,\n) => {\n  if (origObj === nextObj) return false;\n  if (typeof origObj !== 'object' || origObj === null) return true;\n  if (typeof nextObj !== 'object' || nextObj === null) return true;\n  const used = affected.get(origObj);\n  if (!used) return !!assumeChangedIfNotAffected;\n  if (cache) {\n    const hit = cache.get(origObj);\n    if (hit && hit.nextObj === nextObj) {\n      return hit.changed;\n    }\n    // for object with cycles (changed is `undefined`)\n    cache.set(origObj, { nextObj });\n  }\n  let changed = null;\n  // eslint-disable-next-line no-restricted-syntax\n  for (const key of used) {\n    const c = key === OWN_KEYS_SYMBOL ? isOwnKeysChanged(origObj, nextObj)\n      : isDeepChanged(\n        origObj[key],\n        nextObj[key],\n        affected,\n        cache,\n        assumeChangedIfNotAffected !== false,\n      );\n    if (typeof c === 'boolean') changed = c;\n    if (changed) break;\n  }\n  if (changed === null) changed = !!assumeChangedIfNotAffected;\n  if (cache) {\n    cache.set(origObj, { nextObj, changed });\n  }\n  return changed;\n};\n","import { Action, Store } from 'redux';\nimport { readable } from 'svelte/store';\n\n/**\n * Take Redux store and return a global state for Svelte.\n * @example\n * import { createStore } from 'redux';\n * import { bind } from 'svelte3-redux';\n * const store = createStore(reducer);\n * export default bind(store);\n */\nexport const bind = <S, A extends Action>(store: Store<S, A>) => {\n  const state = readable(store.getState(), (set) => {\n    const unsubscribe = store.subscribe(() => {\n      set(store.getState());\n    });\n    return unsubscribe;\n  });\n  return {\n    subscribe: state.subscribe,\n    dispatch: store.dispatch,\n  };\n};\n","import { Action, Store } from 'redux';\nimport { readable } from 'svelte/store';\n\nimport { createDeepProxy, isDeepChanged } from './deepProxy';\n\n/**\n * Take Redux store and return a global state for Svelte.\n * With state usage tracking.\n * @example\n * import { createStore } from 'redux';\n * import { bindTracked } from 'svelte3-redux';\n * const store = createStore(reducer);\n * export default () => bindTracked(store);\n */\nexport const bindTracked = <S, A extends Action>(store: Store<S, A>) => {\n  const proxyCache = new WeakMap();\n  let lastTracked: {\n    state: S;\n    affected: WeakMap<object, unknown>;\n    cache: WeakMap<object, unknown>;\n  };\n  const wrapState = (state: S) => {\n    const affected = new WeakMap();\n    const wrapped = createDeepProxy(state, affected, proxyCache);\n    lastTracked = {\n      state,\n      affected,\n      cache: new WeakMap(),\n    };\n    return wrapped;\n  };\n  const initialState = wrapState(store.getState());\n  const { subscribe } = readable(initialState, (set) => {\n    const unsubscribe = store.subscribe(() => {\n      const nextState = store.getState();\n      if (lastTracked.state === nextState\n        || !isDeepChanged(\n          lastTracked.state,\n          nextState,\n          lastTracked.affected,\n          lastTracked.cache,\n        )) {\n        // not changed\n        return;\n      }\n      set(wrapState(nextState));\n    });\n    return unsubscribe;\n  });\n  return {\n    subscribe,\n    dispatch: store.dispatch,\n  };\n};\n"],"names":["OWN_KEYS_SYMBOL","Symbol","createDeepProxy","obj","affected","proxyCache","proto","Object","getPrototypeOf","prototype","Array","e","isPlainObject","proxyHandler","get","recordUsage","key","used","this","originalObj","Set","set","add","target","has","ownKeys","Reflect","proxy","Proxy","isFrozen","isArray","from","assign","unfreeze","isOwnKeysChanged","origObj","nextObj","origKeys","nextKeys","length","some","k","i","store","subscribe","readable","getState","dispatch","lastTracked","WeakMap","wrapState","state","wrapped","cache","initialState","nextState","isDeepChanged","assumeChangedIfNotAffected","hit","changed","c"],"mappings":"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"}