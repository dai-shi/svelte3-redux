{"version":3,"file":"index.esm.js","sources":["../src/bind.ts","../src/deepProxy.js","../src/bindTracked.ts"],"sourcesContent":["import { Action, Store } from 'redux';\nimport { readable } from 'svelte/store';\n\n/**\n * Take Redux store and return a global state for Svelte.\n * @example\n * import { createStore } from 'redux';\n * import { bind } from 'svelte3-redux';\n * const store = createStore(reducer);\n * export default bind(store);\n */\nexport const bind = <S, A extends Action>(store: Store<S, A>) => {\n  const state = readable(store.getState(), (set) => {\n    const unsubscribe = store.subscribe(() => {\n      set(store.getState());\n    });\n    return unsubscribe;\n  });\n  return {\n    subscribe: state.subscribe,\n    dispatch: store.dispatch,\n  };\n};\n","// -------------------------------------------------------\n// deep proxy\n// -------------------------------------------------------\n\nconst OWN_KEYS_SYMBOL = Symbol('OWN_KEYS');\n\n// check if obj is a plain object or an array\nconst isPlainObject = (obj) => {\n  try {\n    const proto = Object.getPrototypeOf(obj);\n    return proto === Object.prototype || proto === Array.prototype;\n  } catch (e) {\n    return false;\n  }\n};\n\n// copy obj if frozen\nconst unfreeze = (obj) => {\n  if (!Object.isFrozen(obj)) return obj;\n  if (Array.isArray(obj)) {\n    return Array.from(obj);\n  }\n  return Object.assign({}, obj);\n};\n\nconst createProxyHandler = () => ({\n  recordUsage(key) {\n    let used = this.affected.get(this.originalObj);\n    if (!used) {\n      used = new Set();\n      this.affected.set(this.originalObj, used);\n    }\n    used.add(key);\n  },\n  get(target, key) {\n    this.recordUsage(key);\n    // eslint-disable-next-line no-use-before-define, @typescript-eslint/no-use-before-define\n    return createDeepProxy(target[key], this.affected, this.proxyCache);\n  },\n  has(target, key) {\n    // LIMITATION:\n    // We simply record the same as get.\n    // This means { a: {} } and { a: {} } is detected as changed,\n    // if 'a' in obj is handled.\n    this.recordUsage(key);\n    return key in target;\n  },\n  ownKeys(target) {\n    this.recordUsage(OWN_KEYS_SYMBOL);\n    return Reflect.ownKeys(target);\n  },\n});\n\nexport const createDeepProxy = (obj, affected, proxyCache) => {\n  if (!isPlainObject(obj)) return obj;\n  let proxyHandler = proxyCache && proxyCache.get(obj);\n  if (!proxyHandler) {\n    proxyHandler = createProxyHandler();\n    proxyHandler.proxy = new Proxy(unfreeze(obj), proxyHandler);\n    proxyHandler.originalObj = obj;\n    if (proxyCache) {\n      proxyCache.set(obj, proxyHandler);\n    }\n  }\n  proxyHandler.affected = affected;\n  proxyHandler.proxyCache = proxyCache;\n  return proxyHandler.proxy;\n};\n\nconst isOwnKeysChanged = (origObj, nextObj) => {\n  const origKeys = Reflect.ownKeys(origObj);\n  const nextKeys = Reflect.ownKeys(nextObj);\n  return origKeys.length !== nextKeys.length\n    || origKeys.some((k, i) => k !== nextKeys[i]);\n};\n\nexport const isDeepChanged = (\n  origObj,\n  nextObj,\n  affected,\n  cache,\n  assumeChangedIfNotAffected,\n) => {\n  if (origObj === nextObj) return false;\n  if (typeof origObj !== 'object' || origObj === null) return true;\n  if (typeof nextObj !== 'object' || nextObj === null) return true;\n  const used = affected.get(origObj);\n  if (!used) return !!assumeChangedIfNotAffected;\n  if (cache) {\n    const hit = cache.get(origObj);\n    if (hit && hit.nextObj === nextObj) {\n      return hit.changed;\n    }\n    // for object with cycles (changed is `undefined`)\n    cache.set(origObj, { nextObj });\n  }\n  let changed = null;\n  // eslint-disable-next-line no-restricted-syntax\n  for (const key of used) {\n    const c = key === OWN_KEYS_SYMBOL ? isOwnKeysChanged(origObj, nextObj)\n      : isDeepChanged(\n        origObj[key],\n        nextObj[key],\n        affected,\n        cache,\n        assumeChangedIfNotAffected !== false,\n      );\n    if (typeof c === 'boolean') changed = c;\n    if (changed) break;\n  }\n  if (changed === null) changed = !!assumeChangedIfNotAffected;\n  if (cache) {\n    cache.set(origObj, { nextObj, changed });\n  }\n  return changed;\n};\n","import { Action, Store } from 'redux';\nimport { readable } from 'svelte/store';\n\nimport { createDeepProxy, isDeepChanged } from './deepProxy';\n\n/**\n * Take Redux store and return a global state for Svelte.\n * With state usage tracking.\n * @example\n * import { createStore } from 'redux';\n * import { bindTracked } from 'svelte3-redux';\n * const store = createStore(reducer);\n * export default () => bindTracked(store);\n */\nexport const bindTracked = <S, A extends Action>(store: Store<S, A>) => {\n  const proxyCache = new WeakMap();\n  let lastTracked: {\n    state: S;\n    affected: WeakMap<object, unknown>;\n    cache: WeakMap<object, unknown>;\n  };\n  const wrapState = (state: S) => {\n    const affected = new WeakMap();\n    const wrapped = createDeepProxy(state, affected, proxyCache);\n    lastTracked = {\n      state,\n      affected,\n      cache: new WeakMap(),\n    };\n    return wrapped;\n  };\n  const initialState = wrapState(store.getState());\n  const { subscribe } = readable(initialState, (set) => {\n    const unsubscribe = store.subscribe(() => {\n      const nextState = store.getState();\n      if (lastTracked.state === nextState\n        || !isDeepChanged(\n          lastTracked.state,\n          nextState,\n          lastTracked.affected,\n          lastTracked.cache,\n        )) {\n        // not changed\n        return;\n      }\n      set(wrapState(nextState));\n    });\n    return unsubscribe;\n  });\n  return {\n    subscribe,\n    dispatch: store.dispatch,\n  };\n};\n"],"names":["bind","store","subscribe","readable","getState","set","dispatch","OWN_KEYS_SYMBOL","Symbol","createDeepProxy","obj","affected","proxyCache","proto","Object","getPrototypeOf","prototype","Array","e","isPlainObject","proxyHandler","get","recordUsage","key","used","this","originalObj","Set","add","target","has","ownKeys","Reflect","proxy","Proxy","isFrozen","isArray","from","assign","unfreeze","isOwnKeysChanged","origObj","nextObj","origKeys","nextKeys","length","some","k","i","bindTracked","lastTracked","WeakMap","wrapState","state","wrapped","cache","initialState","nextState","isDeepChanged","assumeChangedIfNotAffected","hit","changed","c"],"mappings":"wCAWaA,IAAAA,EAAO,SAAsBC,GAOxC,MAAO,CACLC,UAPYC,EAASF,EAAMG,YAAY,SAACC,GAIxC,OAHoBJ,EAAMC,WAAU,WAClCG,EAAIJ,EAAMG,kBAKKF,UACjBI,SAAUL,EAAMK,WChBdC,EAAkBC,OAAO,YAiDlBC,EAAkB,SAACC,EAAKC,EAAUC,GAC7C,IA/CoB,SAACF,GACrB,IACE,IAAMG,EAAQC,OAAOC,eAAeL,GACpC,OAAOG,IAAUC,OAAOE,WAAaH,IAAUI,MAAMD,UACrD,MAAOE,GACP,UA0CGC,CAAcT,GAAM,OAAOA,EAChC,IAAIU,EAAeR,GAAcA,EAAWS,IAAIX,GAWhD,OAVKU,KACHA,EAhC8B,CAChCE,qBAAYC,GACV,IAAIC,EAAOC,KAAKd,SAASU,IAAII,KAAKC,aAC7BF,IACHA,EAAO,IAAIG,IACXF,KAAKd,SAASN,IAAIoB,KAAKC,YAAaF,IAEtCA,EAAKI,IAAIL,IAEXF,aAAIQ,EAAQN,GAGV,OAFAE,KAAKH,YAAYC,GAEVd,EAAgBoB,EAAON,GAAME,KAAKd,SAAUc,KAAKb,aAE1DkB,aAAID,EAAQN,GAMV,OADAE,KAAKH,YAAYC,GACVA,KAAOM,GAEhBE,iBAAQF,GAEN,OADAJ,KAAKH,YAAYf,GACVyB,QAAQD,QAAQF,MASVI,MAAQ,IAAIC,MAzCZ,SAACxB,GAChB,OAAKI,OAAOqB,SAASzB,GACjBO,MAAMmB,QAAQ1B,GACTO,MAAMoB,KAAK3B,GAEbI,OAAOwB,OAAO,GAAI5B,GAJSA,EAwCD6B,CAAS7B,GAAMU,GAC9CA,EAAaM,YAAchB,EACvBE,GACFA,EAAWP,IAAIK,EAAKU,IAGxBA,EAAaT,SAAWA,EACxBS,EAAaR,WAAaA,EACnBQ,EAAaa,OAGhBO,EAAmB,SAACC,EAASC,GACjC,IAAMC,EAAWX,QAAQD,QAAQU,GAC3BG,EAAWZ,QAAQD,QAAQW,GACjC,OAAOC,EAASE,SAAWD,EAASC,QAC/BF,EAASG,MAAK,SAACC,EAAGC,UAAMD,IAAMH,EAASI,OC3DjCC,EAAc,SAAsBhD,GAC/C,IACIiD,EADEtC,EAAa,IAAIuC,QAMjBC,EAAY,SAACC,GACjB,IAAM1C,EAAW,IAAIwC,QACfG,EAAU7C,EAAgB4C,EAAO1C,EAAUC,GAMjD,OALAsC,EAAc,CACZG,MAAAA,EACA1C,SAAAA,EACA4C,MAAO,IAAIJ,SAENG,GAEHE,EAAeJ,EAAUnD,EAAMG,YAkBrC,MAAO,CACLF,UAlBoBC,EAASqD,GAAc,SAACnD,GAe5C,OAdoBJ,EAAMC,WAAU,WAClC,IAAMuD,EAAYxD,EAAMG,WACpB8C,EAAYG,QAAUI,GDyCH,SAAhBC,EACXjB,EACAC,EACA/B,EACA4C,EACAI,GAEA,GAAIlB,IAAYC,EAAS,SACzB,GAAuB,iBAAZD,GAAoC,OAAZA,EAAkB,SACrD,GAAuB,iBAAZC,GAAoC,OAAZA,EAAkB,SACrD,IAAMlB,EAAOb,EAASU,IAAIoB,GAC1B,IAAKjB,EAAM,QAASmC,EACpB,GAAIJ,EAAO,CACT,IAAMK,EAAML,EAAMlC,IAAIoB,GACtB,GAAImB,GAAOA,EAAIlB,UAAYA,EACzB,OAAOkB,EAAIC,QAGbN,EAAMlD,IAAIoC,EAAS,CAAEC,QAAAA,IAEvB,IAAImB,EAAU,OAEIrC,yBAAlB,iCAAwB,yFAAbD,IACHuC,EAAIvC,IAAQhB,EAAkBiC,EAAiBC,EAASC,GAC1DgB,EACAjB,EAAQlB,GACRmB,EAAQnB,GACRZ,EACA4C,GAC+B,IAA/BI,GAGJ,GADiB,kBAANG,IAAiBD,EAAUC,GAClCD,EAAS,MAMf,OAJgB,OAAZA,IAAkBA,IAAYF,GAC9BJ,GACFA,EAAMlD,IAAIoC,EAAS,CAAEC,QAAAA,EAASmB,QAAAA,IAEzBA,EC9EGH,CACFR,EAAYG,MACZI,EACAP,EAAYvC,SACZuC,EAAYK,QAKhBlD,EAAI+C,EAAUK,UAbVvD,UAmBNI,SAAUL,EAAMK"}